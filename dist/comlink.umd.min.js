(function(a){if("object"==typeof module&&"object"==typeof module.exports){var b=a(require,exports);b!==void 0&&(module.exports=b)}else"function"==typeof define&&define.amd&&define(["require","exports"],a)})(function(a,b){"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.Comlink=function(){function a(b){if(!d(b))throw Error("endpoint does not have all of addEventListener, removeEventListener and postMessage defined");return e(b),k(async(c,d,e)=>{const f=await i(b,{type:c,callPath:d,argumentsList:e},n(e)),g=f.data;return"PROXY"===g.type?a(g.endpoint):g.obj})}function b(a){return a[t]=!0,a}function c(a,g){if(!d(g))throw Error("endpoint does not have all of addEventListener, removeEventListener and postMessage defined");e(g),f(g,async function(d){if(!d.data.id)return;const e=d.data;let f=await e.callPath.reduce((a,b)=>a[b],a);switch(e.type){case"APPLY":{e.callPath.pop();const c=await e.callPath.reduce((a,b)=>a[b],a),d="AsyncGeneratorFunction"===f.constructor.name;f=await f.apply(c,e.argumentsList),d&&(f=b(f))}case"GET":{const a=p(f);return a.id=e.id,g.postMessage(a,n([a]))}case"CONSTRUCT":{const a=new f(...(e.argumentsList||[])),{port1:b,port2:d}=new MessageChannel;return c(a,b),g.postMessage({id:e.id,type:"PROXY",endpoint:d},[d])}}})}function d(a){return"addEventListener"in a&&"removeEventListener"in a&&"postMessage"in a}function e(a){h(a)&&a.start()}function f(a,b){a.addEventListener("message",b)}function g(a,b){a.removeEventListener("message",b)}function h(a){return"MessagePort"===a.constructor.name}function i(a,b,c){const d=`${q}-${r++}`;return new Promise((e)=>{f(a,function b(c){c.data.id!==d||(g(a,b),e(c))}),b=Object.assign({},b,{id:d}),a.postMessage(b,c)})}function j(){return"asyncIterator"in Symbol}function k(a){let b=[];return new Proxy(function(){},{construct(c,d){const e=a("CONSTRUCT",b,d);return b=[],e},apply(c,d,e){if("bind"===b[b.length-1]){const c=b.slice();return b=[],(...b)=>a("APPLY",c.slice(0,-1),b)}const f=a("APPLY",b,e);return b=[],f},get(c,d,e){if("then"===d&&0===b.length)return{then:()=>e};if(j()&&d===Symbol.asyncIterator)return()=>e;if("then"===d){const c=a("GET",b);return b=[],Promise.resolve(c).then.bind(c)}return b.push(d),e}})}function l(a){return s.some((b)=>a instanceof b)}function*m(a){if(!a)return;if("string"==typeof a)return;yield a;let b=Object.values(a);Array.isArray(a)&&(b=a);for(const c of b)yield*m(c)}function n(a){const b=[];for(const c of m(a))l(c)&&b.push(c);return b}function o(a){return a&&a[t]}function p(a){if(o(a)){const{port1:b,port2:d}=new MessageChannel;return c(a,b),{type:"PROXY",endpoint:d}}return{type:"OBJECT",obj:a}}const q=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);let r=0;const s=[ArrayBuffer,MessagePort],t=Symbol("proxyValue");return{proxy:a,proxyValue:b,expose:c,windowEndpoint:function(a){if("Window"!==self.constructor.name)throw Error("self is not a window");return{addEventListener:self.addEventListener.bind(self),removeEventListener:self.removeEventListener.bind(self),postMessage:(b,c)=>a.postMessage(b,"*",c)}}}}()});
