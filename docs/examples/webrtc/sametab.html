<!doctype html>
<script src="https://cdn.jsdelivr.net/npm/comlinkjs/comlink.global.js"></script>
<script>
  const [c1, c2] = [1, 2].map(i => new RTCPeerConnection(null, null));

  function comlinkHandler(f) {
    return event => {
      const data = JSON.parse(event.data);
      // I can’t mutate `event.data` so I’m totally cheating here
      return f({data});
    }
  }

  function toComlinkEndpoint(con) {
    return {
      addEventListener: (name, f) => con.addEventListener(name, comlinkHandler(f)),
      removeEventListener: _ => {}, // lol
      postMessage: (msg, transferables) => con.send(JSON.stringify(msg)),
    };
  }

  function setupRTCDataChannel() {
    return new Promise(async mainResolve => {
      const channel = c1.createDataChannel('comlink', null);
      const channelReady = new Promise(resolve => {
        channel.onopen = ({target}) => {
          if (target.readyState === 'open')
            resolve();
        };
      });
      c1.onicecandidate = ({candidate}) => {
        if (!candidate) return;
        c2.addIceCandidate(candidate);
      };
      c2.ondatachannel = event => {
        mainResolve([channel, event.channel]);
      };
      c2.onicecandidate = ({candidate}) => {
        if (!candidate) return;
        c1.addIceCandidate(candidate);
      };

      const offer = await c1.createOffer();
      await c1.setLocalDescription(offer);
      await c2.setRemoteDescription(offer);
      const answer = await c2.createAnswer()
      await c2.setLocalDescription(answer);
      await c1.setRemoteDescription(answer);
      await channelReady;
    });
  }

  async function init() {
    const [c1, c2] = await setupRTCDataChannel();

    Comlink.expose({
      counter: 0,
      inc() {
        this.counter++;
      }
    }, toComlinkEndpoint(c2));

    const api = Comlink.proxy(toComlinkEndpoint(c1));
    console.log(await api.counter);
    await api.inc();
    console.log(await api.counter);
  }

  init();
</script>
